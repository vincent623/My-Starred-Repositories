name: ðŸ¤– Update Starred Repositories

on:
  # æ¯æ—¥è‡ªåŠ¨è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼ŒUTCæ—¶é—´å‡Œæ™¨1ç‚¹ï¼‰
  schedule:
    - cron: '0 1 * * *'
  
  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒé€‰æ‹©è¿è¡Œæ¨¡å¼
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼ (auto/daily/weekly)'
        required: true
        default: 'auto'
        type: choice
        options:
        - auto
        - daily
        - weekly
      force_reanalyze:
        description: 'å¼ºåˆ¶é‡æ–°åˆ†æžæ‰€æœ‰ä»“åº“'
        required: false
        default: false
        type: boolean
      sample_size:
        description: 'æµ‹è¯•æ¨¡å¼ï¼šä»…åˆ†æžå‰Nä¸ªä»“åº“ï¼ˆç•™ç©ºåˆ™å…¨éƒ¨åˆ†æžï¼‰'
        required: false
        type: string

jobs:
  update-starred-repos:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º60åˆ†é’Ÿ
    
    # æŽˆäºˆå¯¹ä»“åº“å†…å®¹çš„å†™æƒé™ï¼Œä»¥ä¾¿å¯ä»¥ git push
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }} # ä½¿ç”¨å…·æœ‰å†™æƒé™çš„ GITHUB_TOKEN
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ï¼Œä»¥ä¾¿æ­£ç¡® diff

    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ðŸ’¾ Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ðŸš€ Run analysis
      env:
        # ======================= çŽ¯å¢ƒå˜é‡é…ç½® =======================
        # æ•æ„Ÿä¿¡æ¯ï¼šä»Ž GitHub Secrets è¯»å–
        # è¯·ç¡®ä¿åœ¨ä»“åº“çš„ Settings -> Secrets and variables -> Actions ä¸­è®¾ç½®äº†è¿™äº›å€¼
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }} # å¦‚æžœä½ ä¸ç”¨SiliconFlowï¼Œå¯ä»¥åˆ é™¤æˆ–ç•™ç©ºè¿™ä¸ªsecret

        # éžæ•æ„Ÿé…ç½®ï¼šç›´æŽ¥å†™åœ¨è¿™é‡Œï¼Œæ–¹ä¾¿ä¿®æ”¹å’Œç‰ˆæœ¬æŽ§åˆ¶
        LLM_API_BASE_URL: https://openrouter.ai/api/v1
        LLM_MODEL_NAME: qwen/qwen3-30b-a3b-instruct-2507
        # ==========================================================
      run: |
        # æ£€æŸ¥å…³é”®çš„ secret æ˜¯å¦è®¾ç½®
        if [ -z "$LLM_API_KEY" ]; then
          echo "::error::LLM_API_KEY secret is not set or empty! Please configure it in repository settings."
          exit 1
        fi
        
        # æž„å»ºå‘½ä»¤å‚æ•°
        CMD="python main_v3.py"
        
        if [ -n "${{ github.event.inputs.mode }}" ]; then
          CMD="$CMD --mode ${{ github.event.inputs.mode }}"
        else
          CMD="$CMD --mode auto" # schedule è§¦å‘æ—¶ä½¿ç”¨é»˜è®¤å€¼
        fi
        
        if [ "${{ github.event.inputs.force_reanalyze }}" = "true" ]; then
          CMD="$CMD --force-reanalyze"
        fi
        
        if [ -n "${{ github.event.inputs.sample_size }}" ]; then
          CMD="$CMD --sample ${{ github.event.inputs.sample_size }}"
        fi
        
        echo "æ‰§è¡Œå‘½ä»¤: $CMD"
        $CMD

    - name: ðŸ“Š Show statistics
      if: always() # æ— è®ºä¸Šä¸€æ­¥æ˜¯å¦æˆåŠŸï¼Œéƒ½å°è¯•æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
      run: |
        echo "=== æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯ ==="
        python main_v3.py --stats || echo "æ— æ³•èŽ·å–ç»Ÿè®¡ä¿¡æ¯"
        
    - name: ðŸ“ Commit and push changes
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´ï¼Œå¦‚æžœæ²¡æœ‰å°±æå‰é€€å‡ºï¼Œé¿å…ç©ºæäº¤
        if git diff --quiet && git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          exit 0
        fi
        
        # ã€å…³é”®ä¿®æ”¹ã€‘ä½¿ç”¨ 'git add -A' æ¥æš‚å­˜æ‰€æœ‰å˜æ›´ï¼ˆæ–°å¢žã€ä¿®æ”¹ã€åˆ é™¤ï¼‰
        # è¿™æ¯”æŒ‡å®šå…·ä½“æ–‡ä»¶åæ›´å¥å£®ï¼Œä¸ä¼šå› ä¸ºæŸä¸ªæ–‡ä»¶ä¸å­˜åœ¨è€Œå¤±è´¥
        echo "æ­£åœ¨æš‚å­˜æ‰€æœ‰å˜æ›´..."
        git add -A
        
        # å†æ¬¡æ£€æŸ¥æš‚å­˜åŒºï¼Œç¡®ä¿æœ‰å†…å®¹å¯æäº¤
        if git diff --cached --quiet; then
          echo "æš‚å­˜åŒºä¸ºç©ºï¼Œå¯èƒ½æ˜¯ git add å¤±è´¥æˆ–æ²¡æœ‰éœ€è¦è¿½è¸ªçš„æ–‡ä»¶å˜æ›´ã€‚"
          exit 0
        fi
        
        # ç”Ÿæˆæäº¤ä¿¡æ¯
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
        MODE="${{ github.event.inputs.mode || 'auto' }}"
        
        if [ "${{ github.event.inputs.force_reanalyze }}" = "true" ]; then
          COMMIT_MSG="ðŸ”„ Chore: Force re-analyze all repos at $TIMESTAMP"
        elif [ -n "${{ github.event.inputs.sample_size }}" ]; then
          COMMIT_MSG="ðŸ§ª Test: Run on sample size of ${{ github.event.inputs.sample_size }} at $TIMESTAMP"
        else
          COMMIT_MSG="ðŸ¤– Feat: Auto-update starred repos analysis ($MODE mode) at $TIMESTAMP"
        fi
        
        # æäº¤å˜æ›´
        echo "æ­£åœ¨æäº¤å˜æ›´..."
        git commit -m "$COMMIT_MSG"
        
        echo "æ­£åœ¨æŽ¨é€åˆ°è¿œç¨‹ä»“åº“..."
        git push
        
    - name: ðŸ“‹ Upload artifacts
      uses: actions/upload-artifact@v4
      if: always() # æ— è®ºæˆåŠŸä¸Žå¦ï¼Œéƒ½ä¸Šä¼ æ—¥å¿—å’Œæ•°æ®åº“æ–‡ä»¶
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          starred_repos.log
          debug.log
          data/starred_repos_v3.db
        retention-days: 7 # æ—¥å¿—å’Œæ•°æ®åº“ä¿ç•™7å¤©
        
    - name: ðŸ“ˆ Create job summary
      if: always()
      run: |
        echo "## ðŸŽ¯ è¿è¡Œæ€»ç»“" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ¨¡å¼**: ${{ github.event.inputs.mode || 'auto' }}" >> $GITHUB_STEP_SUMMARY
        echo "**å¼ºåˆ¶é‡æ–°åˆ†æž**: ${{ github.event.inputs.force_reanalyze || 'false' }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ github.event.inputs.sample_size }}" ]; then
          echo "**æµ‹è¯•æ¨¡å¼**: ä»…åˆ†æžå‰ ${{ github.event.inputs.sample_size }} ä¸ªä»“åº“" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æ•°æ®åº“ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        python main_v3.py --stats 2>/dev/null || echo "æ— æ³•èŽ·å–ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— ç›¸å…³é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
        echo "- [ðŸ“š æŸ¥çœ‹æ›´æ–°åŽçš„ README](https://github.com/${{ github.repository }}/blob/main/README.md)" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "weekly_report.md" ]; then
          echo "- [ðŸ“Š æŸ¥çœ‹æœ¬å‘¨æŠ¥å‘Š](https://github.com/${{ github.repository }}/blob/main/weekly_report.md)" >> $GITHUB_STEP_SUMMARY
        fi
